---
title: "Visualization of Single-Cell Transcriptomics of Zebrafish Pigment Cells"
author: "Diogo Esteves"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Instalação Bioconductor
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install()

# Instalação Monocle 3, usando o pacote devtools
if (!requireNamespace("devtools", quietly = TRUE))
    install.packages("devtools")
devtools::install_github("cole-trapnell-lab/monocle3", ref="master")
```

```{r pacotes}
# Instalação e carregamento condicional dos pacotes necessários, para agora
necessary_packages <- c("ggplot2", "dplyr", "tidyr", "data.table", "monocle3", "plotly", "viridis", "DelayedArray", "devtools", "htmlwidgets", "VGAM", "forcats")
new_packages <- necessary_packages[!necessary_packages %in% installed.packages()[,"Package"]]
if(length(new_packages)) install.packages(new_packages)
lapply(necessary_packages, library, character.only = TRUE)
```

NOTA: Este ficheiro efetua os downloads dos dados automaticamente à medida que avançamos na análise, as próximas secções detalham a origem destes dados.

# Configuração do Ambiente

Passo importante para definir a diretoria para os downloads e ficheiros de apoio, está definida para ser a localização deste ficheiro na máquina.

```{r Ambiente}
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
```

# Links:

## Dados: 
https://cole-trapnell-lab.github.io/zscape/

## Código e Dados Fonte
Os dados que não estão disponíveis nos repositórios GEO, estão disponíveis:
https://github.com/cole-trapnell-lab/sdg-zfish

## Repositorios GEO:

### GSE202639
O desenvolvimento de atlas celulares compreensivos de embriões inteiros foi facilitado pela evolução das tecnologias de transcritômica de célula única. Mas a maioria desses dados foi coletada de embriões selvagens sem levar em consideração a variação latente no desenvolvimento, este repositorio apresenta dados de transcritômica de célula única de 3,2 milhões de células de embriões de peixe-zebra em desenvolvimento de 1812, que incluem 19 pontos de tempo e 23 perturbações genéticas. A alta replicação deste estudo (8 ou mais embriões por condição) permite estimar as variações na abundância de tipos celulares em todo o organismo e identificar desvios dependentes de perturbação na composição de tipos celulares em comparação com embriões selvagens. A técnica por eles utilizada é sensível a tipos celulares raros, resolvendo trajetórias de desenvolvimento e dependências genéticas nos neurônios dos gânglios cranianos, uma população celular que representa menos de 1% do embrião:
https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE202639

### GSE112294
Perfil de expressão de sequenciação de alta qualidade. O mapeamento de alta taxa de diferenciação celular a partir de dados de célula única promete facilitar investigações sistemáticas sobre o desenvolvimento e doenças em vertebrados. Aqui, aplicamos sequenciação de RNA de célula única a mais de 92,000 células de embriões de peixe-zebra durante o primeiro dia de desenvolvimento:
https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE112294
ou:
http://zebrafish-dev.cells.ucsc.edu/

# Hashing de oligonucleotidos para transcritómica de peixe-zebra em células únicas

## Download dos Dados

Ficheiros:
https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE202639

- AVISO: São cerca de 4GBs. Certifiquem-se que a máquina reúne os requisitos, que estão na diretoria certa e a correr em modo administrador antes de avançar mais no script.
- PASSO DEMORADO, mediante a velocidade de rede e a máquina usada. Necessário cumprir com todos os pré-requisitos de pacotes e dependências até aqui incluindo o ficheiro `Projeto_utils.R`

```{r download}
# Configurar o diretório de trabalho para o diretório deste ficheiro .Rmd
setwd(dirname(rstudioapi::getSourceEditorContext()$path))

# URLs dos ficheiros
url_utils <- "https://raw.githubusercontent.com/dasesteves/projeto/main/Projeto_utils.R"
url_ref_cds <- "https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE202639&format=file&file=GSE202639%5Freference%5Fcds%2ERDS%2Egz"
url_ref_emb_cds <- "https://raw.githubusercontent.com/cole-trapnell-lab/sdg-zfish/main/data/all-ref_cell_count_cds.RDS"
url_mut_emb_cds <- "https://raw.githubusercontent.com/cole-trapnell-lab/sdg-zfish/main/data/zperturb_cell_count_cds.RDS.gz"
url_emb_cds_36h <- "https://raw.githubusercontent.com/cole-trapnell-lab/sdg-zfish/main/data/mut_emb_cds_36hpf_with_coords.RDS"
url_dact_df <- "https://raw.githubusercontent.com/cole-trapnell-lab/sdg-zfish/main/data/zperturb_beta-bin_results_broadtype_clean.csv.gz"
url_sig_df <- "https://raw.githubusercontent.com/cole-trapnell-lab/sdg-zfish/main/data/sig_broadtype_count_per-genotype-timepoint_q05_fc-pt5.csv"

# Definir nomes dos arquivos
utils <- "Projeto_utils.R"
ref_cds_gz <- "GSE202639_reference_cds.RDS.gz"
ref_cds <- "GSE202639_reference_cds.RDS"
ref_emb_cds <- "all-ref_cell_count_cds.RDS"
mut_emb_cds <- "zperturb_cell_count_cds.RDS"
emb_cds_36h <- "mut_emb_cds_36hpf_with_coords.RDS"
dact_df_gz <- "zperturb_beta-bin_results_broadtype_clean.csv.gz"
dact_df_raw <- "zperturb_beta-bin_results_broadtype_clean.csv"
sig_df_raw <- "sig_broadtype_count_per-genotype-timepoint_q05_fc-pt5.csv"

# Função para verificar, baixar e extrair arquivos. Apenas executa novamente o download e a extração caso não estejam presentes estes ficheiros nesta diretoria
options(timeout = 1200) # 20 minutos para tempo máximo de download, aumentar se a net for lenta
download_file_if_not_exists <- function(url, file_name) {
  if (!file.exists(file_name)) {
    message("A descarregar ", file_name, " de ", url)
    download.file(url, file_name)
    if (grepl(".gz$", file_name)) {
      R.utils::gunzip(file_name, overwrite = TRUE)
    }
  } else {
    message(file_name, " já existe.")
  }
}

# Baixar e carregar os arquivos
download_file_if_not_exists(url_utils, utils)
download_file_if_not_exists(url_ref_cds, ref_cds_gz)
download_file_if_not_exists(url_ref_emb_cds, ref_emb_cds)
download_file_if_not_exists(url_mut_emb_cds, mut_emb_cds)
download_file_if_not_exists(url_emb_cds_36h, emb_cds_36h)
download_file_if_not_exists(url_dact_df, dact_df_gz)
download_file_if_not_exists(url_sig_df, sig_df)

# Verificar se o arquivo foi baixado com sucesso
if (!file.exists(utils)) {
  stop("Erro: Falha no download do arquivo ", utils)
}

```

## Carregamento dos dados
Nesta secção, os dados descarregados são lidos e preparados para análise.

```{r Carregamento}
# Definir nomes dos arquivos
utils <- "Projeto_utils.R"
ref_cds_gz <- "GSE202639_reference_cds.RDS.gz"
ref_cds <- "GSE202639_reference_cds.RDS"
ref_emb_cds <- "all-ref_cell_count_cds.RDS"
mut_emb_cds <- "zperturb_cell_count_cds.RDS"
emb_cds_36h <- "mut_emb_cds_36hpf_with_coords.RDS"
dact_df_gz <- "zperturb_beta-bin_results_broadtype_clean.csv.gz"

# Carregar o script com funções de apoio
message("A carregar o script de utilitários ", utils)
source(utils)

# Ler o arquivo descomprimido
ref_cds <- readRDS("GSE202639_reference_cds.RDS")

ref_coldata <-  
  ref_cds %>%
  colData() %>%
  as.data.frame()
```

## Definir cores para os tempos de amostragem
Aqui definimos as cores que serão usadas para representar diferentes pontos de tempo.

```{r cores}
#utilizei as mesmas cores da figura 1 do artigo do projeto ZScape

rainbow_timepoint_colors <-  
  c("18h" = "#DF4828", 
    "24h" = "#E78C35", 
    "36h" = "#F6C141", 
    "48h" = "#4EB265", 
    "72h" = "#1965B0")

num_colors <- ref_coldata %>%
  filter(!is.na(timepoint)) %>%
  pull(timepoint) %>%
  unique() %>%
  sort() %>%
  length()

full_spectrum_timepoint <- colorRampPalette(rainbow_timepoint_colors)(num_colors) 

names(full_spectrum_timepoint) <- ref_coldata %>%
  filter(!is.na(timepoint)) %>%
  pull(timepoint) %>%
  unique() %>%
  sort()
```

## Espaço amostral
Visualização do número de indivíduos em diferentes pontos de tempo e boxplot com a análise da variação no número de células em diferentes pontos de tempo.

```{r barplot}
ggplot(ref_coldata %>%
         group_by(timepoint) %>%
         summarise(n = n()) %>%
         drop_na()) +
  geom_bar(aes(x = reorder(as.character(timepoint), -timepoint),
               y = n,
               fill = as.character(timepoint)),
           stat = "identity",
           color = "black",
           linewidth = 0.2) +
  theme_classic() +
  theme(legend.position = "none",
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        plot.background = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank()) +
  labs(x = "Tempos de amostragem", y = "Número de contagens") +
  scale_fill_manual(values = full_spectrum_timepoint) +
  coord_flip()

ggsave("fig1_barplot.png",
       dpi = 750,
       height = 3,
       width = 1,
       bg = "transparent")
```

```{r boxplot}

# Gráfico de Boxplot
ggplot(ref_coldata %>%
         group_by(timepoint, Oligo) %>%
         summarise(n = n(), .groups = 'drop') %>%
         drop_na()) +
  geom_boxplot(aes(x = reorder(as.character(timepoint), -timepoint),
                   y = log10(n),
                   fill = as.character(timepoint)),
               color = "black",
               size = 0.1,
               outlier.size = 0.2,
               outlier.stroke = 0) +
  theme_classic() +
  scale_y_continuous(breaks = c(2, 3, 4), limits = c(1.5, 4.5)) +
  labs(x = "Tempos de amostragem", y = NULL) +  # Define o título do eixo y e remove o título do eixo x, notem que, apesar de estar ao contrário aqui no grafico aparece correto
  theme(legend.position = "none",
        axis.text.y = element_text(), 
        axis.title.y = element_text(size = 10, face = "bold"),  # Ajusta o estilo do título do eixo y
        plot.background = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.y = element_blank(),
        panel.background = element_blank()) +
  scale_fill_manual(values = full_spectrum_timepoint) +
  coord_flip()

ggsave("fig2_boxplot.png",
         dpi = 750,
         height = 3,
         width = 0.5,
         bg = "transparent")

```

## UMAP

```{r UMAP}
vibrant.colors <-  
  c('#EE7733', '#0077BB', '#228833', '#33BBEE', '#EE3377', '#CC3311',
    '#AA3377', '#009988', '#004488', '#DDAA33', '#99CC66','#D590DD')

bright.colors <-  
  c('#4477AA', 
    '#EE6677', 
    '#228833', 
    '#CCBB44', 
    '#66CCEE',
    '#AA3377', 
    '#BBBBBB')


num.colors.tissue <-  
  ref_coldata %>%
  filter(!is.na(tissue)) %>%
  pull(tissue) %>%
  unique() %>%
  sort() %>%
  length()

tissue.colors <- colorRampPalette(c(vibrant.colors,bright.colors))(num.colors.tissue) 
```

### 24h
```{r UMAP-24h}
# Individual UMAP 24hours 
ggplot(ref_coldata %>%
         sample_n(size = dim(ref_coldata)[1]) %>%
         filter(!is.na(timepoint))) +
  geom_point(aes(x = umap3d_1,
                 y = umap3d_2),
             color = "grey80",
             stroke = 0,
             size = 0.1) +
  geom_point(data = ref_coldata %>%
               filter(Oligo == "24h_ctrl-inj_P10_H7"),
             aes(x = umap3d_1,
                 y = umap3d_2,
                 color = as.character(timepoint)),
             stroke = 0,
             size = 0.125) +
  theme_void() +
  theme(legend.position = "right") +
  scale_color_manual(values = full_spectrum_timepoint)

ggsave("fig3_umap_24h.png",
         dpi = 600,
         height = 1,
         width = 1,
         bg = "transparent")

```
### 48h
a resolver este problema...
```{r UMAP-48h}
ggplot(ref_coldata %>%
         sample_n(size = dim(ref_coldata)[1]) %>%
         filter(!is.na(timepoint))) +
  geom_point(aes(x = umap3d_1,
                 y = umap3d_2),
             color = "grey80",
             stroke = 0,
             size = 0.1) +
  geom_point(data = ref_coldata %>%
               filter(Oligo == "48h_ctrl-inj_P2_D11"),
             aes(x = umap3d_1,
                 y = umap3d_2,
                 color = as.character(timepoint)),
             stroke = 0,
             size = 0.125) +
  theme_void() +
  theme(legend.position = "right") +
  scale_color_manual(values = full_spectrum_timepoint)

ggsave("fig4_umap_48h.png",
         dpi = 600,
         height = 1,
         width = 1,
         bg = "transparent")


```

### Resultado final
a resolver a legenda
```{r UMAP_tempo}
# plotar células por tempo
ggplot(ref_coldata %>%
         sample_n(size = dim(ref_coldata)[1]) %>%
         filter(!is.na(timepoint))) +
  geom_point(aes(x = umap3d_1,
                 y = umap3d_2),
             color = "black",
             stroke = 0,
             size = 0.15) +
  geom_point(aes(x = umap3d_1,
                 y = umap3d_2,
                 color = as.character(timepoint)),
             stroke = 0,
             size = 0.11) +
  theme_void() +
  theme(legend.position = "bottom") +  # Define a posição da legenda
  scale_color_manual(values = full_spectrum_timepoint) +
  ggtitle("Células por Tempo")

ggsave("fig5_umap_tempos.png",
         dpi = 750,
         height = 1.5,
         width = 1.5,
         bg = "transparent")
```

```{r UMAP_tecido}
# plotar células por tecido
ggplot(ref_coldata %>%
         sample_n(size = dim(ref_coldata)[1]) %>%
         filter(!is.na(timepoint)) %>%
         group_by(tissue) %>%
         add_tally() %>%
         arrange(-n)) +
  geom_point(aes(x = umap3d_1,
                 y = umap3d_2),
             color = "black",
             stroke = 0,
             size = 0.2) +
  geom_point(aes(x = umap3d_1,
                 y = umap3d_2,
                 color = as.character(tissue)),
             stroke = 0,
             size = 0.15) +
  theme_void() +
  theme(legend.position = "bottom") +  # Define a posição da legenda
  scale_color_manual(values = tissue.colors) +
  ggtitle("Células por Tecido")

ggsave("fig6_umap_tecidos.png",
         dpi = 1200,
         height = 3,
         width = 3,
         bg = "transparent")

```

## Testes de variancia

### teste 1
```{r testvariancia1}
# Baixar o arquivo
if (!file.exists("ref_broad_celltype_disps.csv")) {
  download.file("https://raw.githubusercontent.com/cole-trapnell-lab/sdg-zfish/main/data/ref_broad_celltype_disps.csv", "ref_broad_celltype_disps.csv")
} else {
    message("ref_broad_celltype_disps.csv", " already exists.")
}

# Carregar os dados
celltype_disps <- fread("ref_broad_celltype_disps.csv", 
                        sep = ",", stringsAsFactors = F, 
                        data.table = F)

# set thresholds
sig_thresh = 0.05
times = c(20, 22, 24, 42)

plot_df = celltype_disps %>% 
  filter(cells_per_embryo > 3) %>% 
  filter(timepoint %in% times)

# plot variance faceted by time
ggplot(data=plot_df) + 
  geom_line(aes(cells_per_embryo, model_fit), color="black", data=plot_df) + 
  geom_ribbon(aes(cells_per_embryo, ymin=model_fit_lower, ymax=model_fit_upper), alpha=0.2) +
  geom_point(aes(cells_per_embryo, cells_per_embryo_cv, color=cv_z_stat_p_val < sig_thresh), size = 0.75) + 
  geom_linerange(aes(cells_per_embryo, 
                     ymin=cells_per_embryo_cv - cells_per_embryo_cv.stderr, 
                     ymax=cells_per_embryo_cv + cells_per_embryo_cv.stderr),
                 data=plot_df %>% filter(cv_z_stat_p_val < sig_thresh)) +
  facet_wrap(~timepoint, scales = "free_x", nrow = 1) +
  scale_color_manual(values = c("steelblue", "tomato")) +
  scale_y_log10() +
  scale_x_log10() +
  theme_classic() +
  theme(legend.position = "top")

ggsave("fig7_variancia_tempos.pdf",
       width = 5,
       height = 2.2)
```

### teste 2
Após este teste e gráfico consequente, focarei apenas nas celulas pigmentares e transciptómica associada a estas:

- xanthophores (yellow)
- erythrophores (red)
- iridophores (reflective / iridescent)
- leucophores (white)
- melanophores (black/brown)
- cyanophores (blue)

```{r testvariancia2}

ggplot(celltype_disps %>% 
         filter(cells_per_embryo > 3), 
       aes(x = reorder(cell_group, cv_test_stat, FUN = median), y = cv_test_stat, fill = cell_group)) + 
  geom_boxplot() +
  coord_flip() +
  theme_classic() +
  xlab("Tipos de Células (broad)") +
  ylab("Variância das Contagens (CV test statistic)") +
  theme(legend.position = "none", 
        axis.text = element_text(size = 6), 
        axis.line = element_line(), axis.ticks = element_line())

ggsave(filename = "Fig8_varianciatotal_boxplot.pdf", width = 8, height = 8)
```

# Analise de expressão
```{r DACT}
dact_df <- fread("zperturb_beta-bin_results_broadtype_clean.csv", 
                 sep = ",", data.table = F) # DACT results

# resumir o número de DACT por perturbação
dact_summary <- dact_df %>% 
  select(gene_target = geno.v.wt, cell_group, timepoint, qval) %>% 
  filter(qval < 0.05) %>% 
  distinct() %>% 
  group_by(gene_target, timepoint) %>% 
  tally(name = "dact_n")

dact_summary$timepoint <- as.character(dact_summary$timepoint)

# adicionar etiqueta de controlo
colData(emb_cds_36h)$is_ctrl = colData(emb_cds_36h) %>% 
  as.data.frame() %>% 
  mutate(is_ctrl = case_when(grepl("ctrl", gene_target) ~ TRUE,
                             TRUE ~ FALSE)) %>% 
  pull(is_ctrl)

# extrair dados para plotagem
coldat_filt <- colData(emb_cds_36h) %>% 
  as_tibble() %>%
  left_join(dact_summary, by = c("gene_target", "timepoint")) %>% 
  distinct()

# plot embryos colored by genotype and sized by number of dacts
# definir cores dos genótipos
mut_colors = c("ctrl-inj" = "grey80", 
               "cdx4" = "#F12CBA", 
               "cdx4-cdx1a" = "#A63587", 
               "tbxta" = "#F47534", 
               "wnt3a-wnt8" = "#E4A341",
               "tbx16" = "#A12926", 
               "tbx16-mut" = "#D63732", 
               "tbx16-tbx16l" = "#D63732", 
               "tbx16-msgn1" = "#E68784", 
               "smo" = "#510027", 
               "noto" = "#892E58", 
               "noto-mut" = "#892E58", 
               "egr2b" = "#056596", 
               "epha4a" = "#2D358D",
               "mafba" = "#29686D", 
               "mafba-mut" = "#29686D", 
               "hoxb1a" = "#785BDA", 
               "zc4h2" = "#50849A",
               "tbx1" = "#5640F1", 
               "hand2" = "#DA99B8", 
               "phox2a" = "#AC8BF0", 
               "met" = "#33B8D8",
               "met-mut" = "#33B8D8", 
               "foxi1" = "#2E91FF",
               "hgfa" = "#F5BE66", 
               "hgfa-mut" = "#F5BE66", 
               "tfap2a" = "#4AB633", 
               "foxd3" = "#3F7933", 
               "tfap2a-foxd3" = "#157B00")
```

```{r}
# plotar embriões coloridos por genótipo e tamanho pelo número de dacts
ggplot() +
  geom_point(data = coldat_filt %>%
               filter(gene_target_test == "ctrl"),
             mapping = aes(x = umap1, y = umap2), 
             color = "grey70", size = 2, stroke = 0) +
  geom_point(data = coldat_filt %>%
               filter(gene_target_test != "ctrl"),
             mapping = aes(x = umap1, y = umap2,
                           color = gene_target_test, size = dact_n, alpha = 0.5, stroke = 0)) +
  scale_color_manual(values = mut_colors) +
  scale_size_binned(range = c(1, 4)) +
  theme_void() #+ 
  #theme(legend.position = "none")

# ggsave("fig2c_emb_36hpf_umap_DACT-size.pdf", width = 4, height = 4)
ggsave("emb_36hpf_umap_DACT-size_w-legend.pdf", width = 4, height = 4)

```

```{r}

# Plotar apenas embriões de controlo
ggplot() +
  geom_point(data = coldat_filt %>% 
               filter(is_ctrl == T),
             mapping = aes(x = umap1, y = umap2,
                           label = gene_target), color = "grey70", 
             size = 1, stroke = 0, alpha = 0.6) +
  theme_void() +
  theme(legend.position = "none")

ggsave("fig2c_ctrl-only_36h_emb_umap.pdf", 
       width = 0.6, height = 0.6)
```

```{r}
sig_df = fread("data/sig_broadtype_count_per-genotype-timepoint_q05_fc-pt5.csv", sep = ",", stringsAsFactors = F, 
                 data.table = F)

geno_order = c("cdx4",
                 "cdx4-cdx1a",
                 "tbxta",
                 "wnt3a-wnt8",
                 "tbx16",
                 "tbx16-msgn1",
                 "tbx16-tbx16l",
                 "smo",
                 "noto",
                 "egr2b",
                 "epha4a",
                 "mafba",
                 "hoxb1a",
                 "zc4h2",
                 "tbx1",
                 "hand2",
                 "phox2a",
                 "tfap2a",
                 "foxd3",
                 "tfap2a-foxd3",
                 "met",
                 "hgfa-mut",
                 "foxi1")

num_ct_df = dact_summary %>% 
  ungroup() %>% 
  filter(gene_target %in% geno_order) %>%
  mutate(gene_target = factor(gene_target, levels = geno_order),
         timepoint = factor(timepoint))

ggplot(num_ct_df, aes(x = timepoint, 
                      y = fct_rev(gene_target), 
                      fill = dact_n)) +
  geom_dotplot(binaxis = "y", stackdir = "center") +
  scale_fill_viridis_c(option = "G") +
  theme(axis.text.x = element_text(size = 8, color = "black"),
        axis.title.y = element_blank(), 
        text = element_text(size = 8, color = "black"),
        axis.title.x = element_blank(),
        axis.line = element_line(colour = "black", size = 1), 
        axis.ticks = element_line(colour = "black", size = 0.25)) +
  monocle3:::monocle_theme_opts()

ggsave("geno_timepoint_num-types_dotplot.pdf", width = 2.3, height = 4)
  
# Figure 2f ---------------------------------------------------------------

# tbx16 group boxplots

# load data
summary_merge = fread("data/zperturb-all_broadtype_summary_merge.csv",
                      sep = ",", data.table = F, stringsAsFactors = F, na.strings = "")

# plot by cell type facet
genos <- c("ctrl-inj", "tbx16", "tbx16-msgn1", "tbx16-tbx16l")
types <- c("posterior spinal cord progenitors",
          "fast-committed myocyte",
          "mesodermal progenitor cells (contains PSM)")
times <- c("24")

cell_cols <- c("grey80", "#ffd5c2", "#f28f3b", "#c8553d")

summary_merge %>% 
  filter(genotype %in% genos) %>% 
  filter(cell_type %in% types) %>%
  filter(timepoint %in% times) %>%
  mutate(cells_per_1000 = round(cells / total_cells * 1000)) %>%
  ggplot(aes(x = factor(genotype, levels = genos), 
             y = cells_per_1000, 
             fill = genotype)) +
  geom_boxplot(color = "black", size = 0.3, outlier.size = 0.5, outlier.shape = NA) +
  geom_jitter(size = 0.5, color = "black", width = .2) +
  theme(axis.title.x = element_blank(), legend.position = "none", 
        axis.ticks = element_line(color = "black", size = .3),
        legend.title = element_blank(), 
        axis.text.x = element_text(angle= 45, hjust = 1, color = "black"),
        axis.text.y = element_text(color = "black")) +
  scale_fill_manual(values = cell_cols) +
  facet_wrap(~cell_type, nrow = 1, scales = "free_y") +
  monocle3:::monocle_theme_opts()

ggsave("fig2f_tbx16-grp_counts-boxplot_CPT_celltype-facet.pdf", width = 6, height = 3)

# Related extended data figures -------------------------------------------

# Extended data figure 12 -------------------------------------------------

# plot embryo UMAP with all time points
emb_cds = readRDS("zperturb_cell_count_cds.RDS")

timept_clrs = 
  c("18" = "#DF4828", 
    "24" = "#E78C35", 
    "36" = "#F6C141", 
    "48" = "#4EB265", 
    "72" = "#1965B0")

# plot
emb_coldata <- colData(ref_emb_cds) %>% 
  as.data.frame() 

ggplot() +
  geom_point(data = emb_coldata %>% 
               filter(!grepl("ctrl", gene_target)),
             aes(x = umap1,
                 y = umap2,
                 color = timepoint),
             stroke = 0,
             size = .8,
             inherit.aes = FALSE) +
  geom_point(data = emb_coldata %>%
               filter(grepl("ctrl", gene_target)),
             aes(x = umap1,
                 y = umap2,
                 fill = timepoint),
             shape = 21,
             color = "black",
             size = .8,
             stroke = 0.5,
             inherit.aes = FALSE) +
  scale_color_manual(values = timept_clrs) +
  scale_fill_manual(values = timept_clrs) +
  theme_void() +
  theme(legend.position = "none")


ggsave("EDF12_gap16-all_embryo_wt-highlight_timept_umap.pdf", 
       width = 3, height = 3,
       bg = "transparent")

# Extended data figure 14 -------------------------------------------------

res_df <- fread("data/zperturb_beta-bin_results_broadtype_clean.csv", 
               sep = ",", data.table = F, stringsAsFactors = F, na.strings = "")

# filter for cell type and genotypes of interest
genos = c("tbx16", "tbx16-msgn1", "tbx16-tbx16l", "ctrl-inj", "tbx16-mut")
celltypes = c("posterior spinal cord progenitors",
              "mesodermal progenitor cells (contains PSM)",
              "dorsal spinal cord neuron",
              "mature slow muscle", 
              "mature fast muscle",
              "fast-committed myocyte", "slow-committed myocyte",
              "dorsal spinal cord neuron",
              "myoblast",
              "neuron (+ spinal cord)",
              "red blood cell")

qval_thresh = 0.01
sig_df = res_df %>% 
  filter(geno.v.wt %in% genos) %>% 
  filter(cell_group %in% celltypes) %>% 
  dplyr::mutate(sig_fc = case_when(qval < qval_thresh ~ TRUE, 
                                   TRUE ~ FALSE))

# summarize fc in a matrix
hm_wide = sig_df %>%
  select(geno.v.wt, timepoint, cell_group, abund_log2fc) %>%
  pivot_wider(
    names_from = cell_group,
    values_from = abund_log2fc,
    values_fill = c(0)
  )

hm_plot = hm_wide %>%
  pivot_longer(!geno.v.wt:timepoint,
               names_to = "cell_group",
               values_to = "plot") %>%
  left_join(
    sig_df %>%
      select(geno.v.wt, timepoint, cell_group, sig_fc),
    by = c("geno.v.wt", "timepoint", "cell_group"),
    
  ) %>%
  mutate(
    sig_fc = replace_na(sig_fc, FALSE),
    geno_timepoint = paste0(geno.v.wt, "_", timepoint)
  ) %>%
  arrange(timepoint, geno.v.wt) %>%
  mutate(timepoint = as.factor(timepoint),
         cell_group = as.factor(cell_group))

new_levels = hm_plot %>% distinct(geno_timepoint) %>% pull %>% as.character
hm_plot$geno_timepoint = factor(hm_plot$geno_timepoint, levels = new_levels)

# get clustering results
hm_wider = hm_wide %>%
  mutate(geno_timepoint = paste0(geno.v.wt, "_", timepoint)) %>%
  select(geno_timepoint, everything(),-geno.v.wt,-timepoint)
hm_mat <- as.matrix(hm_wider[,-1])
rownames(hm_mat) <- hm_wider$geno_timepoint
hm_mat <- t(hm_mat)
hm.dendro <- as.dendrogram(hclust(d = dist(x = hm_mat)))
hm.order <- order.dendrogram(hm.dendro)

# reorder cell type factor
hm_plot$cell_group <- factor(as.character(hm_plot$cell_group),
                             rownames(hm_mat[hm.order, ]))

# make df for plotting significance boxes
fms = hm_plot[hm_plot$sig_fc, c("geno_timepoint", "cell_group")]
fms$geno_timepoint = as.integer(fms$geno_timepoint)
fms$cell_group = as.integer(fms$cell_group)

# plot heatmap
ggplot(hm_plot,
       aes(y = cell_group, x = geno_timepoint, fill = plot)) +
  geom_tile() +
  scale_fill_gradient2(
    low = "#3234a9",
    mid = "white",
    high = "darkred",
    na.value = "black",
    name = ""
  ) +
  geom_rect(
    data = fms,
    size = 0.3,
    fill = NA,
    colour = "black",
    aes(
      xmin = geno_timepoint - 0.5,
      xmax = geno_timepoint + 0.5,
      ymin = cell_group - 0.5,
      ymax = cell_group + 0.5
    )
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.y = element_blank(),
    text = element_text(size = 10),
    axis.title.x = element_blank(),
    plot.title = element_text(hjust = 0.75),
    plot.margin = unit(c(.5, .5, .5, 2.5), "cm"),
    legend.key.size = unit(0.5, 'cm'),
    axis.line = element_line(colour = "black", size = 1),
    axis.ticks = element_line(colour = "black", size = 0.25)
  ) +
  coord_equal() +
  coord_flip() +
  monocle3:::monocle_theme_opts()

ggsave("EDF14_tbx16-grp_sc-neuron_meso_abund-heatmap.pdf",
       units = "in",
       width = 5,
       height = 5)

# plot a representation of mean cells per embryo for each cell type above
# use control mean values

ctrl_coldata <- fread("reference_cell_metadata.csv") # download from ZSCAPE

coldat_filt <- ctrl_coldata %>% 
  filter(gene_target == "ctrl-inj") %>%
  filter(timepoint == 24) %>% 
  group_by(embryo, cell_type_broad) %>% 
  summarize(ct_tot = sum(n())) %>%
  ungroup()

emb_tot_mean <- ctrl_coldata %>% 
  filter(gene_target == "ctrl-inj") %>% 
  filter(timepoint == 24) %>% 
  group_by(embryo) %>% 
  tally(name = "emb_tot")

coldat_filt <- coldat_filt %>% 
  left_join(emb_tot_mean, 
            by = "embryo") %>% 
  mutate(ct_frac = ct_tot/emb_tot)

mean_fracs_df <- coldat_filt %>% 
  group_by(cell_type_broad) %>% 
  summarize(mean_frac = round(100*mean(ct_frac), 2))

mean_fracs_df %>% 
  arrange(-mean_frac) %>% 
  head(20)

sum(mean_fracs_df$mean_frac)

# plot
ggplot(mean_fracs_df %>% 
         filter(cell_type_broad %in% celltypes),
       aes(y = 1, x = cell_type_broad, fill = mean_frac)) +
  geom_tile() +
  scale_fill_gradientn(colours = c("#fdf8e1","#ffea00", "#ffb700", "#ff9500", "#ff8800")) +
  coord_equal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.y = element_blank()) +
  monocle3:::monocle_theme_opts()

ggsave("EDF14_tbx16-grp_sc-neuron_meso_abund-heatmap_mean-percent.pdf",
       units = "in",
       width = 5,
       height = 5)