---
title: "Análise Eficiente de Células Pigmentares em Zebrafish"
author: "Diogo Esteves"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Matrix)
library(SingleCellExperiment)
library(Seurat)
library(dplyr)
library(ggplot2)
```

# Instalação e Carregamento de Pacotes
```{r Pacotes}
# Instalação condicional de pacotes necessários
necessary_packages <- c("ggplot2", "dplyr", "Seurat", "Matrix", "SingleCellExperiment")
new_packages <- necessary_packages[!necessary_packages %in% installed.packages()[,"Package"]]
if(length(new_packages)) install.packages(new_packages)
lapply(necessary_packages, library, character.only = TRUE)
```

# Configuração do Ambiente

```{r Ambiente}
setwd(dirname(rstudioapi::getSourceEditorContext()$path))
```

# Aquisição e Pré-Processamento dos Dados

## Download dos Dados

Ficheiros:
https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE202639

- AVISO: São muitos GBs certifiquem-se que a máquina reúne os requisitos, que estão na diretoria certa e a correr em modo administrador antes de avançar mais no script.

- PASSO MUITO DEMORADO, mediante a velocidade de rede e a máquina usada, necessário cumprir com todos os pré-requisitos até aqui. 


```{r download}
# Definir URLs e destinos para download
files_to_download <- list(
  "GSE202639_zperturb_full_cds.RDS.gz" = "https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE202639&format=file&file=GSE202639%5Fzperturb%5Ffull%5Fcds%2ERDS%2Egz",
  "GSE202639_zperturb_full_cell_metadata.csv.gz" = "https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE202639&format=file&file=GSE202639%5Fzperturb%5Ffull%5Fcell%5Fmetadata%2Ecsv%2Egz",
  "GSE202639_zperturb_full_gene_metadata.csv.gz" = "https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE202639&format=file&file=GSE202639%5Fzperturb%5Ffull%5Fgene%5Fmetadata%2Ecsv%2Egz",
  "GSE202639_zperturb_full_raw_counts.RDS.gz" = "https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE202639&format=file&file=GSE202639%5Fzperturb%5Ffull%5Fraw%5Fcounts%2ERDS%2Egz"
)

# Download e descompressão dos dados
for (file_name in names(files_to_download)) {
  local_file_name <- gsub(".gz", "", file_name)
  if (!file.exists(local_file_name)) {
    download.file(files_to_download[[file_name]], file_name)
    # Descomprimir arquivo se for um gzipped RDS
    if (grepl(".gz$", file_name)) {
      R.utils::gunzip(file_name, overwrite = TRUE)
    }
  }
  # Carregar arquivos descomprimidos
  if (grepl(".csv", local_file_name)) {
    assign(gsub(".csv$", "", local_file_name), read.csv(local_file_name))
  } else if (grepl(".RDS", local_file_name)) {
    assign(gsub(".RDS$", "", local_file_name), readRDS(local_file_name))
  }
}

```
## SingleCellExperiment

```{r Carregamento}
# Carregar e preparar os dados
raw_counts <- Matrix::Matrix(readRDS("GSE202639_zperturb_full_raw_counts.RDS"), sparse = TRUE)
cell_metadata <- read.csv("GSE202639_zperturb_full_cell_metadata.csv")
gene_metadata <- read.csv("GSE202639_zperturb_full_gene_metadata.csv")

# Criar objeto SingleCellExperiment
sce <- SingleCellExperiment(assays = list(counts = raw_counts))
colData(sce) <- DataFrame(cell_metadata)
rowData(sce) <- DataFrame(gene_metadata)
```

# Análise com Seurat

```{r Filtragem}
# Criar objeto Seurat
seurat_obj <- CreateSeuratObject(counts = raw_counts, project = "Pigment Cells")
seurat_obj@meta.data <- cell_metadata

# Pré-processamento e Normalização
seurat_obj <- SCTransform(seurat_obj, verbose = FALSE)  # Utiliza regularização, adequada para grandes datasets

# Executar PCA
seurat_obj <- RunPCA(seurat_obj, features = VariableFeatures(seurat_obj))

# Análise de clustering com base nos PCs
seurat_obj <- FindNeighbors(seurat_obj, dims = 1:15)
seurat_obj <- FindClusters(seurat_obj, resolution = 0.5)

# Redução de dimensionalidade com UMAP para visualização usando os PCs
seurat_obj <- RunUMAP(seurat_obj, dims = 1:15)

# Visualização de UMAP
p <- DimPlot(seurat_obj, reduction = "umap", label = TRUE, pt.size = 0.5) + NoLegend()
print(p)
```
# Visualização de Heatmap das células pigmentares

```{r Heatmap}

FeaturePlot(seurat_obj, features = c("gene1", "gene2", "gene3"))  # Substituir 'gene1', 'gene2', 'gene3' pelos genes de interesse

```{r}



# Análise de Expressão Diferencial e Exportação dos Resultados

```{r ExpDif}
# Análise de expressão diferencial entre os clusters encontrados
markers <- FindAllMarkers(seurat_obj, only.pos = TRUE, min.pct = 0.25, thresh.use = 0.25)
print(head(markers))
```

```{r Exportação}
# Salvar os resultados
ggsave("UMAP_clusters.png", plot = last_plot(), device = "png", width = 8, height = 6)
write.csv(markers, "cell_markers.csv")
```
Análise dos Histogramas e Estatísticas
Número de Genes por Célula:
Média: 344.2 genes por célula.
Mediana: 278 genes por célula.
Máximo: 2527 genes por célula.
A maioria das células tem entre 210 e 404 genes, com uma cauda longa estendendo-se até 2527 genes.
Número de Células por Gene:
Média: 28,873 células por gene.
Mediana: 3,543 células por gene.
Máximo: 2,678,428 células por gene.
A maioria dos genes está presente em algumas centenas a alguns milhares de células, mas alguns genes são extremamente comuns, aparecendo em quase todas as células.

# Análise com Seurat

```{r data-load1}
# Conversão para objeto Seurat para análise detalhada
seurat_obj <- CreateSeuratObject(counts = counts(sce), project = "Pigment Cells")

# Normalização dos dados
seurat_obj <- NormalizeData(seurat_obj, normalization.method = "LogNormalize", scale.factor = 10000)

# Identificação de características variáveis
seurat_obj <- FindVariableFeatures(seurat_obj, selection.method = "vst", nfeatures = 2000)

# Escalamento dos dados
seurat_obj <- ScaleData(seurat_obj)

# Redução de dimensionalidade com PCA
seurat_obj <- RunPCA(seurat_obj, features = VariableFeatures(object = seurat_obj))

# Redução de dimensionalidade com UMAP
seurat_obj <- RunUMAP(seurat_obj, dims = 1:15)

# Clustering
seurat_obj <- FindNeighbors(seurat_obj, dims = 1:15)
seurat_obj <- FindClusters(seurat_obj, resolution = 0.5)

# Visualização dos clusters com UMAP
DimPlot(seurat_obj, reduction = "umap", label = TRUE, pt.size = 0.5) + NoLegend()

```
# Análise de Expressão Diferencial

```{r ExpDif}
# Análise de expressão diferencial para identificar marcadores de célula
markers <- FindAllMarkers(seurat_obj, only.pos = TRUE, min.pct = 0.25, thresh.use = 0.25)

# Visualização dos marcadores de expressão gênica
FeaturePlot(seurat_obj, features = head(markers$gene, 5))

```

#Exportação dos Resultados

```{r preproci}
ggsave("UMAP_clusters.png", plot = last_plot(), device = "png", width = 8, height = 6)

write.csv(markers, "cell_markers.csv")
```

